#!/usr/bin/env python

import paho.mqtt.client as mqtt
import json
import os, time
path_to_watch = "sandbox/"
before = dict ([(f, None) for f in os.listdir (path_to_watch)])
broker_addr="127.0.0.1"

while True:
  try:
    after = dict ([(f, None) for f in os.listdir (path_to_watch)])
    added = [f for f in after if not f in before]
    removed = [f for f in before if not f in after]
    if added:
      print "*** Added: ", ", ".join (added)
      payload='{ "file name" : "' + str(added) + '" }'
      client= mqtt.Client("storage_sensor")
      client.connect(broker_addr, 1883, 60)
      client.publish("mosquitto_sub/file", payload)
      client.disconnect()
    if removed: print "*** Removed: ", ", ".join (removed)
    before = after
    time.sleep (1)
  except (KeyboardInterrupt, SystemExit) as e:
    print (str(e))
    break
